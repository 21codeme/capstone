rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ===== CRITICAL: USER REGISTRATION FIX =====
    
    // Users collection - Allow users to create their own document during registration
    match /users/{userId} {
      // Allow users to read/write their own data (including creation)
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // Instructors can read all user data (for student management)
      allow read: if request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'instructor';
    }
    
    // ===== TEST COLLECTION - FOR DEBUGGING =====
    
    // Test collection - allow all authenticated users for testing
    match /test/{docId} {
      allow read, write: if request.auth != null;
    }
    
    // ===== QUIZ SYSTEM =====
    
    // Quizzes collection - everyone can read, instructors can manage
    match /quizzes/{quizId} {
      allow read: if request.auth != null;
      allow create, update, delete: if request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'instructor';
    }
    
    // Quiz attempts - students can manage their own, instructors can read all
    match /quizAttempts/{docId} {
      allow read, write: if request.auth != null && 
        (resource.data.studentId == request.auth.uid || 
         (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'instructor'));
    }
    
    // ===== MODULE SYSTEM =====
    
    // Modules collection - everyone can read, instructors can manage
    match /modules/{moduleId} {
      allow read: if request.auth != null;
      allow create, update, delete: if request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'instructor';
    }
    
    // Student modules - all authenticated users can read
    match /studentModules/{docId} {
      allow read: if request.auth != null;
      allow create, update: if request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'instructor';
    }
    
    // ===== STUDENT PROGRESS =====
    
    // Student progress - students can manage their own, instructors can read all
    match /studentProgress/{docId} {
      allow read, write: if request.auth != null && 
        (resource.data.studentId == request.auth.uid || 
         (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'instructor'));
    }
    
    // ===== NOTIFICATIONS =====
    
    // Notifications - users can read their own, instructors can create
    match /notifications/{docId} {
      allow read: if request.auth != null && 
        (resource.data.userId == request.auth.uid || 
         (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'instructor'));
      allow create: if request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'instructor';
    }
    
    // ===== DEFAULT RULE =====
    
    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

