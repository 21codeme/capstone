rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    
    // ===== MODULE FILES =====
    
    // Module files - students can download, instructors can upload/manage their own
    match /modules/{moduleId}/{fileName} {
      allow read: if request.auth != null;
      allow write: if request.auth != null &&
        // Check if user document exists
        firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data != null &&
        // Allow only instructors to upload (support both new and legacy schema)
        (
          // New schema: instructors have isStudent == false
          firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data.isStudent == false ||
          // Legacy schema: role == 'instructor'
          firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data.role == 'instructor'
        ) &&
        request.resource.size < 100 * 1024 * 1024 && // 100MB max
        request.resource.contentType.matches('application/pdf|application/msword|application/vnd.openxmlformats-officedocument.wordprocessingml.document|application/vnd.ms-powerpoint|application/vnd.openxmlformats-officedocument.presentationml.presentation|image/.*|video/.*|audio/.*');
      allow delete: if request.auth != null &&
        // Check if user document exists
        firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data != null &&
        // Only instructors can delete modules (support both new and legacy schema)
        (
          // New schema: instructors have isStudent == false
          firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data.isStudent == false ||
          // Legacy schema: role == 'instructor'
          firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data.role == 'instructor'
        );
    }
    
    // ===== PROFILE PICTURES =====
    
    // User profile pictures - users can manage their own
    match /profilePictures/{userId}/{fileName} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
        request.auth.uid == userId &&
        request.auth.token.email_verified == true &&
        request.resource.size < 10 * 1024 * 1024 && // 10MB max
        request.resource.contentType.matches('image/.*');
      allow delete: if request.auth != null && 
        request.auth.uid == userId;
    }
    
    // ===== QUIZ MEDIA =====
    
    // Quiz media files - students can view; only instructors can upload/manage
    match /quizzes/{quizId}/{fileName} {
      allow read: if request.auth != null;
      allow write: if request.auth != null &&
        // Only instructors can upload quiz media (support both new and legacy schema)
        (
          // New schema: instructors have isStudent == false
          firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data.isStudent == false ||
          // Legacy schema: role == 'instructor'
          firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data.role == 'instructor'
        ) &&
        request.resource.size < 50 * 1024 * 1024 && // 50MB max
        request.resource.contentType.matches('image/.*');
      allow delete: if request.auth != null &&
        // Only instructors can delete quiz media (support both new and legacy schema)
        (
          // New schema: instructors have isStudent == false
          firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data.isStudent == false ||
          // Legacy schema: role == 'instructor'
          firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data.role == 'instructor'
        );
    }
    
    // ===== ASSIGNMENT SUBMISSIONS =====
    
    // Assignment submission files - students can upload their own, instructors can view all
    match /assignments/{assignmentId}/submissions/{studentId}/{fileName} {
      allow read: if request.auth != null && 
        (request.auth.uid == studentId || 
         exists(/databases/$(database)/documents/assignments/$(assignmentId)) &&
         get(/databases/$(database)/documents/assignments/$(assignmentId)).data.instructorId == request.auth.uid);
      allow write: if request.auth != null && 
        request.auth.uid == studentId &&
        request.auth.token.email_verified == true &&
        request.resource.size < 100 * 1024 * 1024 && // 100MB max
        request.resource.contentType.matches('application/pdf|application/msword|application/vnd.openxmlformats-officedocument.wordprocessingml.document|image/.*|video/.*|audio/.*');
      allow delete: if request.auth != null && 
        request.auth.uid == studentId;
    }
    
    // ===== COURSE MATERIALS =====
    
    // Course materials - students can view, instructors can manage their courses
    match /courses/{courseId}/materials/{fileName} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
        request.auth.token.email_verified == true &&
        request.resource.size < 200 * 1024 * 1024 && // 200MB max
        request.resource.contentType.matches('application/pdf|application/msword|application/vnd.openxmlformats-officedocument.wordprocessingml.document|image/.*|video/.*|audio/.*|application/zip|application/x-rar-compressed');
      allow delete: if request.auth != null && 
        request.auth.token.email_verified == true;
    }
    
    // ===== TEMPORARY UPLOADS =====
    
    // Temporary uploads - users can manage their own temp files
    match /temp/{userId}/{fileName} {
      allow read, write: if request.auth != null && 
        request.auth.uid == userId &&
        request.auth.token.email_verified == true &&
        request.resource.size < 50 * 1024 * 1024; // 50MB max
      allow delete: if request.auth != null && 
        request.auth.uid == userId;
    }
    
    // ===== SYSTEM FILES =====
    
    // System files - only instructors can access
    match /system/{fileName} {
      allow read: if request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'instructor';
      allow write: if false; // Only system can modify
    }
    
    // ===== BACKUP & ARCHIVE =====
    
    // Backup files - only instructors can access
    match /backups/{fileName} {
      allow read: if request.auth != null && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'instructor';
      allow write: if false; // Only system can create backups
    }
    
    // ===== DEFAULT RULE =====
    
    // Deny all other access by default
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
